---
title: "AccessPack-Spatial-Availability"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{AccessPack-Spatial-Availability}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(AccessPack)
library(dplyr)
library(ggplot2)
library(sf)
```

## Preamble on Spatial Availability Accessibility calculation
dsds

### 2016 TTS

ds

### Toy Data

Assign impedance function:
```{r}
beta <- 0.0015
od_table <- toy_od_table %>%
  mutate(f = exp(-beta * distance))
```

```{r}
od_table <- od_table %>%
  mutate(V_ij = sp_avail(., 
                                 o_id = Origin, 
                                 d_id = Destination, 
                                 pop = Population, 
                                 opp = Jobs,
                                 f = f))
```

Verify that the sum of all jobs allocated is consistent with the total number of jobs:
```{r}
sum(od_table$V_ij)
```

The total number of jobs is preserved.

Aggregate available jobs by origin:
```{r}
availability <- od_table %>%
  group_by(Origin) %>%
  summarize(avail_jobs = sum(V_ij))
availability
```

Join the availability to the simulated_data:
```{r}
simulated_data <- toy_sim_zones %>%
  left_join(availability, 
            by = c("id" = "Origin"))
```

Plot the availability estimates:
```{r fig.height=3}
avail_jobs_plot <- ggplot() +
  geom_sf(data = simulated_data %>% 
            filter(type == "population"),
          aes(color = avail_jobs,
              size = avail_jobs),
          shape = 17) +
  geom_sf(data = simulated_data %>% 
            filter(type == "population"),
          aes(size = avail_jobs),
          shape = 2) +
  geom_sf(data = simulated_data %>% 
            filter(type == "jobs"),
          aes(size = number,
              shape = )) +
  scale_color_distiller(palette = "OrRd",
                        direction = 1)

avail_jobs_plot
```

How do we interpret this? Accessibility is the number of jobs that can be reached at a given cost. Here, the total number of jobs is a constant. Population center 5 has the greatest availability, due to being a large population center that is moreover relatively close to jobs.

Since the total number of jobs is constant, we can calculate the available jobs per person:
```{r}
simulated_data <- simulated_data %>%
  mutate(avail_jobs_per_person = avail_jobs/number)
```

Plot the availability per person:
```{r fig.height=3}
avail_jobs_person_plot <- ggplot() +
  geom_sf(data = simulated_data %>% 
            filter(type == "population"),
          aes(color = avail_jobs_per_person,
              size = avail_jobs_per_person),
          shape = 17) +
  geom_sf(data = simulated_data %>% 
            filter(type == "population"),
          aes(size = avail_jobs_per_person),
          shape = 2) +
    geom_sf(data = simulated_data %>% 
            filter(type == "jobs"),
              shape = 16) +
  scale_color_gradient2(midpoint = 1)


avail_jobs_person_plot
```
Some population centers have almost two jobs available per person, and others less than one job available per person. This does not mean that people are not taking some of the jobs. It means that controlling for the cost of reaching jobs, they are worse off than those with more jobs spatially available. 
