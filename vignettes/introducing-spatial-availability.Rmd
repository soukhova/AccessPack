---
title: "Introducing Spatial Availability"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introducing Spatial Availability}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6
)
```

Accessibility analysis is widely employed in transportation, geography, public health, and many other areas. It is a relatively simple concept whose appeal derives from combining the spatial distribution of opportunities and the cost of reaching them. Recent works have aimed at making accessibility easier to interpret. This vignette introduces the concept of spatial _availability_, a form of singly-constrained accessibility that preserves the number of opportunities available, and therefore leads to more interpretable results. 

## Accessibility Analysis

Most accessibility measures (excluding utility-based measures) are derived from the gravity model, and are known as _gravity-based_ accessibility. Briefly, consider the following conventional accessibility measure $A_i$ :
$$
A_i = \sum_{j=1}^JW_jf(c_{ij})
$$

\noindent where:

- $i$ is a set of origin locations.
- $j$ is a set of destination locations.
- $W_j$ is the number of opportunities at location $j$. These are opportunities for activity and add some sort of _supply_ to the area;
- $c_{ij}$ is a measure of the cost of moving between $i$ and $j$
- $f(\cdot)$ is an impedance (or distance-decay) function (a monotonically non-increasing or decreasing function of $c_{ij}$).

The accessibility value $A_i$, it can be seen, is the weighted sum of opportunities that can be reached from location $i$, given the cost of travel $c_{ij}$ and an impedance function. Summing the opportunities in the neighborhood of $i$ (the neighborhood is defined by the impedance function) estimates of the total number of opportunities that can be reached from $i$ at a certain cost. Depending on the impedance function, the measure could be cumulative opportunities (if $f(\cdot)$ is a binary or indicator function) or a more traditional gravity measure, for instance with a Gaussian impedance function or an inverse cost impedance function.

We use a toy example to introduce the concept of _spatial availability_, and we will use a conventional accessibility measure for comparison. In this way, we aim to show their differences and discuss how spatial availability improves interpretability in the analysis of spatially dispersed opportunities. 

### Numerical Toy Example

In this section we present a simple numerical example.

Begin by loading the packages needed for the example:
```{r message = FALSE, warning = FALSE}
library(AccessPack)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(patchwork)
library(sf)
```

The setup for the example is a simple system with three employment centers and nine population centers.
```{r ,  message = FALSE, warning = FALSE}
ggplot(data = toy_sim_zones) + 
  geom_sf(aes(color = type,
              shape = type,
              size = number)) +
  geom_sf_text(aes(label = id_short),
               size = 3,
               nudge_y = -600) +
  scale_size(range = c(2, 7)) +
  theme(axis.text = element_blank(),
        legend.position = "none",
        panel.grid = element_blank())
```

```{r fig.height=2, include=FALSE}
ggplot(data = toy_sim_zones) + 
  geom_sf(aes(color = type,
              shape = type,
              size = number)) +
  geom_sf_text(aes(label = id_short),
               size = 3,
               nudge_y = -600) +
  scale_size(range = c(2, 7)) +
  theme(axis.text = element_blank(),
        legend.position = "none",
        panel.grid = element_blank())

ggsave("images/figure-1.png",
       width = 3,
       height = 2)
```

This is the distribution of jobs and population:
```{r echo = FALSE, eval = FALSE}
toy_sim_zones %>%
  st_drop_geometry() %>%
  mutate(fig = "") %>%
  kable(format = "latex",
        booktabs = TRUE) %>%
  column_spec(5, 
              image = "images/figure-1.png") %>%
  collapse_rows(columns = 5, 
                latex_hline = "major", 
                valign = "middle")
```

```{r message = FALSE, warning = FALSE}
toy_sim_zones %>%
  st_drop_geometry() %>%
  kable(format = "html")
```

The accessibility to employment of each of the population centers can be calculated using the expression above for $A_i$. As noted, this yields the number of jobs (opportunities) that are accessible (i.e., can be reached) from each population center, given the cost. 

In this example we use the straight line distance between the population and jobs for $c_{ij}$, and a negative exponential function with $\beta = 0.0015$. The impedance function is calculated as follows:
```{r}
beta <- 0.0015
toy_od_table <- toy_od_table %>%
  mutate(f = exp(-beta * distance))
```

Calculate the accessibility:
```{r message = FALSE, warning = FALSE}
# using the origin-destination table (OD) of all origin to destination trips; filter in only jobs which are mean distance or less away from a population center and sum number of jobs available in each origin (population center)

c_accessibility <- toy_od_table %>% 
  mutate(A_ij = f * Jobs) %>%
  group_by(Origin) %>%
  summarise(A_i = sum(A_ij))
```

Join the results to the geography of the system:
```{r}
#pass conventional accessibility calculation into the spatial object (toy_sim_zones)
toy_sim_zones_access  <- toy_sim_zones %>% 
  left_join(c_accessibility, 
            by = c("id" = "Origin")) 
```

Plot the accessibility to employment in the example;
```{r, message = FALSE, warning = FALSE}
toy_c_access_jobs_plot <- ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(color = A_i,
              size = A_i),
          shape = 17) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(size = A_i),
          shape = 2) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          aes(size = number)) +
  scale_color_distiller(palette = "OrRd",
                        direction = 1) +
  guides(size = "none") + 
  theme(legend.position = "bottom",axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

toy_c_access_jobs_plot 
```

Here we see of the three employment centers (black circles), the bigger the circle the larger number of jobs available. We also see nine population centers (triangles), where the size of the symbol is proportional to the accessibility to jobs. 

- Population centers (triangles) in the middle of the map are relatively close to all three employment centers and thus have the highest levels of job accessibility (i.e. Population center  `r toy_sim_zones_access %>% slice_max(A_i, n=1) %>% pull(id_short)` has the highest accessibility `r  toy_sim_zones_access %>% slice_max(A_i, n=1) %>% pull(A_i)`);

- Population centers (triangles) near the left edge of the map (only in proximity to the small employment center) have the lowest levels of job accessibility (i.e. Population centers  `r toy_sim_zones_access %>% slice_min(A_i, n=1) %>% pull(id_short)` has the lowest accessibility `r toy_sim_zones_access %>% slice_min(A_i, n=1, with_ties = F) %>% pull(A_i)`);

## What are the issues?

What does the highest level of `r  max(toy_sim_zones_access$A_i, na.rm=T)` and the lowest value of `r  min(toy_sim_zones_access$A_i, na.rm=T)` job accessibility mean exactly? We can normalize this value by considering population centers, employment centres, or the average global population or jobs. However, the value is not sensitive to the population at the origin seeking the opportunity (in this case jobs). For this reason, the value of $A_i$ is difficult to interpret. 

This is where the proposed measure of spatial availability measure can help. In the following five sections we will explore this new measure using the toy example introduced. First, we will describe the measure. Second, we will calculate the _spatial availability_ from the perspective of the population. Then, we will calculate the _spatial availability_ from the perspective of the employment centers. Next, we calculate the _spatial availability_ for a segment of specialized working population. Finally, we will compare the conventional accessibility calculation to the proposed _spatial availability_.

## Spatial Availability

As research on proportional allocation (see for instance Paez, Higgins, Vivona, [2019](https://doi.org/10.1371/journal.pone.0218773)), it has become increasingly clear that multiple-counting is commonplace when calculating conventional accessibility $A_i$ for $i=1,\cdots,n$, since every opportunity that can be reached from every $i$ enters the sum. This obscures the interpretability of $A_i$ and fails to answer questions like: "so I live in a population center with very high job accessibility, but so do my numerous neighbors...what does high accessibility actually mean to me?"

For this reason, we propose a related concept that we call _spatial availability_, and that, as we will show, is a singly-constrained measure of accessibility.

How does this work? It all comes down to a specific form of proportional allocation, whereby we allocate opportunities based on the size of the population, and their distance to the opportunities.

This framework is appropriate for indivisible opportunities. Examples of indivisible opportunities include jobs (when a person takes up a job, the same job is no longer available to anyone else) and seats at schools (once a seat has been taken, it is no longer available to another student). From a different perspective, employers may see workers as opportunities, but when a worker takes a job, they are no longer in the available pool of candidates for hiring.

In this framework we distinguish between opportunities and demand. To illustrate the analytical framework, the example of accessibility to employment is illustrative, with "population" in the role of demand and "jobs" in the role of opportunities.

We begin with allocation based on demand (the number of individuals in the population in the labor market). Consider an employment center $j$ with $W_j^r$ jobs of type $r$. There are also $K$ population centers in the region. To allocate the jobs proportionally based on the population of each center we define the following factor:
$$
f^p_{ij} = \frac{P_{i\in r}^\alpha}{\sum_{k=1}^K P_{k\in r}^\alpha}
$$
\noindent where $f^p_{ij}$ is a factor to proportionally allocate a share of the jobs at $j$ to population center $i$. On the right hand side of the equation, $P_{k\in r}$ is the population at location $k$ that is eligible for jobs of type $r$ (maybe those with a certain level of training, or in a designated age group). Here we add a parameter $\alpha$ that can be used to modulate the effect of size in the calculations (i.e., if $\alpha <1$ employment centers draw more rapidly from small centers than from large centers, and when $\alpha>1$ employment centers draw more rapidly from large population centers). The summation in the bottom is over $k=1,\cdots,K$, the number of population centers in the region. The factors $f_{kj}^p$ satisfy the property that $\sum_k^{K} f^p_{kj} = 1$.

The share of jobs allocated to (i.e., available for) each population center is:
$$
V_{kj} = W_jf^p_{kj}
$$
\noindent and since $\sum_k^{K} f^p_{kj} = 1$ it follows that:
$$
\sum_{k=1}^K V_{kj} = W_j 
$$

In other words, the number of jobs is preserved. 

As an example, consider an employment center $j$ in a region with two population centers (say $j$ and $k$). For simplicity, assume that all jobs in the population centers are eligible for the population in this region. The allocation factors for the jobs at $j$ would be:
$$
\begin{array}{l}\
f^p_{ij} = \frac{P_i ^\alpha}{P_i^\alpha + P_k^\alpha}\\
f^p_{kj} = \frac{P_k^\alpha}{P_i^\alpha + P_k^\alpha}\\
\end{array}
$$

Suppose that there are three hundred jobs in the employment center ($W_j = 300$), and that the populations are $P_j=240$ and $P_k=120$. The jobs would be allocated as follows (assuming that $\alpha=1$):
$$
\begin{array}{l}\
V_{ij} = W_j\frac{P_i^\alpha}{P_i^\alpha + P_k^\alpha} = 300\frac{240}{240 + 120} = 300\frac{240}{360} = 200\\
V_{kj} = W_j\frac{P_k^\alpha}{P_i^\alpha + P_k^\alpha} = 300\frac{120}{240 + 120} = 300\frac{120}{360} = 100 \\
\end{array}
$$
Proportionally more jobs are allocated to the bigger center and the total number of jobs is preserved ($\sum_{k=1}^K W_{kj} = W_j$).

The proportional allocation factors above account for the capacity of the employment centers, but they do not account for their location relative to the population centers. The proportional allocation procedure above is insensitive to how far population center $i$ is from employment center $j$. To account for this effect we can define a second set of allocation factors based on distance to the employment centers. These are defined as:
$$
f^d_{ij} = \frac{f(c_{ij})}{\sum_{k=1}^K f(c_{kj})}
$$
\noindent where $c_{ij}$ is the distance/(travel time, etc.) to employment center $j$ from population center $i$, and $f(\cdot)$ is an impedance function (a monotonically decreasing function of $c_{kj}$. The idea is that proportionally more jobs are allocated to closer locations. Assume that the impedance function is:
$$
f(c_{ij}) = \exp(-\beta c_{ij})
$$

Continuing the example, suppose that the distance from population center $i$ to employment center $j$ is 0.6 km, and the distance from population center $k$ to employment center $j$ is 0.3 km. Being closer, we would expect more jobs to be allocated to the population of $i$. The jobs would be sorted as follows:
$$
\begin{array}{l}\
f^d_{ij} = \frac{\exp(-\beta D_{ij})}{\exp(-\beta D_{ij}) + \exp(-\beta D_{kj})}\\
f^d_{kj} = \frac{\exp(-\beta D_{kj})}{\exp(-\beta D_{ij}) + \exp(-\beta D_{kj})}\\
\end{array}
$$

Numerically, the jobs allocated to each population center would be:
$$
\begin{array}{l}\
V^d_{ij} = W_j\frac{\exp(-D_{ij})}{\exp(-D_{ij}) + \exp(-D_{kj})} = 300\frac{\exp(-0.6)}{\exp(-0.6) + \exp(-0.3)} = 3\times 0.426 = 127.8\\
V^d_{kj} = W_j\frac{\exp(-D_{kj})}{\exp(-D_{ij}) + \exp(-D_{kj})} = 300\frac{\exp(-0.3)}{\exp(-0.6) + \exp(-0.3)} = 3\times  0.574 = 172.2\\
\end{array}
$$
Proportionally more jobs are allocated to the closer population center. As before, the sum of jobs allocated to the population centers matches the total number of jobs available.

We can combine the proportional allocation factors by population and distance as follows:
$$
V_{ij} = W_i\frac{f^p_{ij} \cdot f^d_{ij}}{\sum_{k=1}^K f^p_{kj} \cdot f^d_{kj}}
$$
In the example:
$$
\begin{array}{l}\
V_{ij} = W_j\cdot \frac{f^o_{ij} \cdot f^d_{ij}}{f^o_{ij} \cdot f^d_{ij} + f^o_{kj} \cdot f^d_{kj}} = 300 \frac{\big(\frac{2}{3} \big) \big(0.426 \big)}{\big(\frac{2}{3} \big) \big(0.426 \big) + \big(\frac{1}{3} \big) \big(0.574 \big)} = \big(300 \big)\big(\frac{0.284}{0.475} \big)= 179.4\\
V_{kj} = W_j\cdot \frac{f^o_{kj} \cdot f^d_{kj}}{f^o_{ij} \cdot f^d_{ij} + f^o_{ik} \cdot f^d_{ik}} = 300 \frac{\big(\frac{1}{3} \big) \big(0.574 \big)}{\big(\frac{2}{3} \big) \big(0.426 \big) + \big(\frac{1}{3} \big) \big(0.574 \big)}  = \big(300 \big)\big(\frac{0.191}{0.475} \big)= 120.6 \\
\end{array}
$$
Fewer jobs are allocated to population center $i$ compared to the allocation by population size only, to account for the longer distance to reach those jobs. On the other hand, distance alone allocated more jobs to the closer population center (i.e., $k$), but since it is smaller, it also get a smaller proportion of jobs overall. Again, the sum of jobs at employment center $j$ that are allocated to population centers $i$ and $k$ simultaneously based on _population_ and _distance_ is preserved (i.e., $W_{ij} + W_{kj} = W_j$). 

Availability is the sum of available jobs by origin:
$$
V_i = \sum_{j=1}^J V_{ij}
$$

In the following sections we use the same numerical example presented above to illustrate how availability $V_i$ is calculated. We conclude by contrasting the two measures in the final section. 

### 1st Use Case: Available Jobs for The Working Population

First we assign an impedance function:
```{r, warning=FALSE}
beta <- 0.0015
toy_od_table <- toy_od_table %>%
  mutate(f = exp(-beta * distance))
```

Next we calculate the _spatial availability_ for each origin:
```{r, warning=FALSE}
toy_od_table <- toy_od_table %>%
  mutate(catch = 1) %>%
  mutate(V_ij = sp_avail(., 
                         o_id = Origin, 
                         d_id = Destination, 
                         pop = Population, 
                         opp = Jobs,
                         r = catch,
                         f = f))
```

Verify that the sum of all jobs allocated is consistent with the total number of jobs:
```{r, warning=FALSE}
sum(toy_od_table$V_ij)

sum_jobs <- toy_od_table %>% group_by(Destination) %>% summarise(Jobs = mean(Jobs))
sum(sum_jobs$Jobs, na.rm = T)
```

The total number of jobs is preserved.

Aggregate available jobs by origin:
```{r, warning=FALSE}
availability <- toy_od_table %>%
  group_by(Origin) %>%
  summarize(avail_jobs = sum(V_ij))
availability
```

Join the availability to the simulated zones:
```{r}
toy_sim_zones_access <- toy_sim_zones_access %>%
  left_join(availability, 
            by = c("id" = "Origin"))
```

Plot the availability estimates:
```{r}
toy_avail_jobs_plot <- ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(color = avail_jobs,
              size = avail_jobs),
          shape = 17) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(size = avail_jobs),
          shape = 2) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          aes(size = number,
              shape = )) +
  scale_color_distiller(palette = "OrRd",
                        direction = 1)+
  guides(size = "none") + 
  theme(legend.position = "bottom",axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

toy_avail_jobs_plot
```

How do we interpret this? Accessibility is the number of jobs that can be reached at a given cost. Here, the total number of jobs is a constant. Population center 5 has the greatest availability, due to being a large population center that is moreover relatively close to jobs.

Since the total number of jobs is constant, we can calculate the available jobs per person:
```{r}
toy_sim_zones_access <- toy_sim_zones_access %>%
  mutate(avail_jobs_per_person = avail_jobs/number)
```

Plot the availability per person:
```{r}
toy_avail_jobs_person_plot <- ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(color = avail_jobs_per_person,
              size = avail_jobs_per_person),
          shape = 17) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(size = avail_jobs_per_person),
          shape = 2) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          shape = 16) +
  scale_color_gradient2(midpoint = 1)+
  guides(size = "none") + 
  theme(legend.position = "bottom",axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

toy_avail_jobs_person_plot
```

Some population centers have almost two jobs available per person, and others less than one job available per person. This does not mean that people are not taking some of the jobs. It means that controlling for the cost of reaching jobs, they are worse off than those with more jobs spatially available. 

### 2nd Use Case: Available Workers for Employment Centers

We can also examine the pool of workers available to each employment center by considering the workers as opportunities and the jobs as the population.

Calculate the proportional allocation of jobs to population (referred to as $W_ij$):
```{r, warning=FALSE}
toy_od_table <- toy_od_table %>%
  mutate(catch = 1) %>%
  mutate(W_ij = sp_avail(., 
                         o_id = Destination, 
                         d_id = Origin, 
                         pop = Jobs, 
                         opp = Population,
                         r = catch,
                         f = f))
```

Verify that the sum of all population allocated is consistent with the total number of population:
```{r, warning=FALSE}
sum(toy_od_table$W_ij)

sum_pop <- toy_od_table %>% group_by(Origin) %>% summarise(Population = mean(Population))
sum(sum_pop$Population, na.rm = T)
```

The total population is preserved.

Aggregate available workers by employment center:
```{r, warning=FALSE}
availability <- toy_od_table %>%
  group_by(Destination) %>%
  summarize(avail_workers = sum(W_ij))
availability
```

Join the availability to the toy_sim_zones_access:
```{r, warning=FALSE}
toy_sim_zones_access <- toy_sim_zones_access %>%
  left_join(availability, 
            by = c("id" = "Destination"))
```

Plot the availability estimates:
```{r, warning=FALSE}
toy_avail_workers_plot <- ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          aes(color = avail_workers,
              size = avail_workers),
          shape = 16) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          aes(size = avail_workers),
          shape = 1) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(size = number),
          shape = 17) +
  scale_color_distiller(palette = "OrRd",
                        direction = 1)+
  guides(size = "none") + 
  theme(legend.position = "bottom",axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

toy_avail_workers_plot
```

Since the total population is constant, we can calculate the available workers per job:
```{r}
toy_sim_zones_access <- toy_sim_zones_access %>%
  mutate(avail_workers_per_job = avail_workers/number)
```

Plot the population availability per job:
```{r}
toy_avail_workers_job_plot <- ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          aes(color = avail_workers_per_job,
              size = avail_workers_per_job),
          shape = 16) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          aes(size = avail_workers_per_job),
          shape = 1) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          shape = 17) +
  scale_color_gradient2(midpoint = 1)+
  guides(size = "none") + 
  theme(legend.position = "bottom",axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

toy_avail_workers_job_plot
```

### 3rd Use Case: Available Jobs for Specialized Working Populations

In this section we introduce catchment/eligibility constraints. Due to differences in educational achievement among the population, the jobs in Employment Center 1 can only be taken by individuals in population centers 1 and 2. Jobs in Employment Center 2 can be taken by individuals in population centers 3, 4, 5, 7, and 8. Lastly, jobs in Employment Center 3 require qualifications available only among individuals in population centers 5, 6, 8, and 9. See figure below.

```{r, include=FALSE}
# Create catchments for visualization:
catchment_1 <- toy_sim_zones_access %>% filter(id == "Employment Center 1" | 
                                                 id == "Population 1" | 
                                                 id == "Population 2") %>%
  st_union %>% 
  st_convex_hull()  %>%
  st_buffer(480) 

catchment_2 <- toy_sim_zones_access %>% filter(id == "Employment Center 2" | 
                                                 id == "Population 3" | 
                                                 id == "Population 4" | 
                                                 id == "Population 5" | 
                                                 id == "Population 7" | 
                                                 id == "Population 8") %>% 
  st_union %>% 
  st_convex_hull()  %>%
  st_buffer(480)

catchment_3 <- toy_sim_zones_access %>% filter(id == "Employment Center 3" | 
                                                 id == "Population 5" | 
                                                 id == "Population 6" |  
                                                 id == "Population 8" | 
                                                 id == "Population 9") %>% 
  st_union %>% 
  st_convex_hull()  %>%
  st_buffer(480)
```

```{r echo = FALSE}
# Plot catchments
ggplot(data = toy_sim_zones_access) + 
  geom_sf(data = catchment_1,
          fill = "orange",
          alpha = 0.1) +
  geom_sf(data = catchment_1,
          color = "orange",
          fill = NA) +
  geom_sf(data = catchment_2,
          fill = "blue",
          alpha = 0.1) +
  geom_sf(data = catchment_2,
          color = "blue",
          fill = NA) +
  geom_sf(data = catchment_3,
          fill = "red",
          alpha = 0.1) +
  geom_sf(data = catchment_3,
          color = "red",
          fill = NA) +
  geom_sf(aes(color = type,
              shape = type,
              size = number)) +
  geom_sf_text(aes(label = id_short),
               size = 3,
               nudge_y = -600) +
  scale_size(range = c(2, 7)) +
  theme(legend.position = "bottom",
        axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
```

Calculate the proportional allocation of opportunities but now with catchment constraint (referred to as $V_ij_r$):
```{r}
toy_od_table <- toy_od_table %>%
  mutate(V_ij_r = sp_avail(.,
                           o_id = Origin,
                           d_id = Destination,
                           pop = Population,
                           opp = Jobs,
                           r = catchments,
                           f = f))
```

Verify that the sum of all jobs allocated is consistent with the total number of jobs:
```{r}
sum(toy_od_table$V_ij_r)

sum_jobs <- toy_od_table %>% group_by(Destination) %>% summarise(Jobs = mean(Jobs))
sum(sum_jobs$Jobs, na.rm = T)
```

The total number of jobs is preserved.

Repeat the availability calculation:
```{r}
availability <- toy_od_table %>%
  group_by(Origin) %>%
  summarize(avail_r = sum(V_ij_r))
availability
```

Join the availability to the toy_sim_zones_access:
```{r}
toy_sim_zones_access <- toy_sim_zones_access %>%
  left_join(availability,
            by = c("id" = "Origin"))
```

Plot the availability estimates:
```{r echo=FALSE, fig.height=6}
toy_avail_r_plot <- ggplot() +
  geom_sf(data = catchment_1,
          fill = "orange",
          alpha = 0.05) +
  geom_sf(data = catchment_1,
          color = "orange",
          fill = NA) +
  geom_sf(data = catchment_2,
          fill = "blue",
          alpha = 0.05) +
  geom_sf(data = catchment_2,
          color = "blue",
          fill = NA) +
  geom_sf(data = catchment_3,
          fill = "red",
          alpha = 0.05) +
  geom_sf(data = catchment_3,
          color = "red",
          fill = NA) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "population"),
          aes(color = avail_r,
              size = avail_r),
          shape = 17) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "population"),
          aes(size = avail_r),
          shape = 2) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "jobs"),
          aes(size = number,
              shape = )) +
  scale_color_distiller(palette = "OrRd",
                        direction = 1)+
  guides(size = "none") + 
  theme(legend.position = "bottom",axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

toy_avail_jobs_plot / toy_avail_r_plot
```

Available jobs per person with catchment/eligibility conditions:
```{r}
toy_sim_zones_access <- toy_sim_zones_access %>%
  mutate(avail_r_per_person = avail_r/number)
```

Plot the availability per person:
```{r fig.height=9, echo=FALSE}
toy_avail_r_person_plot <- ggplot() +
  geom_sf(data = catchment_1,
          fill = "orange",
          alpha = 0.05) +
  geom_sf(data = catchment_1,
          color = "orange",
          fill = NA) +
  geom_sf(data = catchment_2,
          fill = "blue",
          alpha = 0.05) +
  geom_sf(data = catchment_2,
          color = "blue",
          fill = NA) +
  geom_sf(data = catchment_3,
          fill = "red",
          alpha = 0.05) +
  geom_sf(data = catchment_3,
          color = "red",
          fill = NA) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "population"),
          aes(color = avail_r_per_person,
              size = avail_r_per_person),
          shape = 17) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "population"),
          aes(size = avail_r_per_person),
          shape = 2) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "jobs"),
          shape = 16) +
  scale_color_gradient2(midpoint = 1)+
  guides(size = "none") + 
  theme(legend.position = "bottom",axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

toy_avail_jobs_person_plot / toy_avail_r_person_plot
```

## Comparing Conventional Accessibility and Spatial Availability

Below we compare the conventional accessibility and the initial _spatial availability_ use case. 
```{r fig.height=9}
toy_avail_jobs_plot <- ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(color = avail_jobs,
              size = avail_jobs),
          shape = 17) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(size = avail_jobs),
          shape = 2) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          aes(size = number,
              shape = )) +
  scale_color_distiller(palette = "OrRd",
                        direction = 1) +
  guides(size = "none") + 
  theme(legend.position = "bottom",axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

toy_c_access_jobs_plot / toy_avail_jobs_plot
```

How are the two measures different? 

Well, firstly, the sum of all  _spatial availability_ values is equal to the total number of jobs within the Employment centers, as such, the _spatial availability_ value for each population center reflects how many jobs are _available_. This is interpretable. Comparatively, conventional accessibility values associated with each population centers reflects how many jobs can _potentially_ be reached by each population center; these values are not adjusted proportionally to the number of population (i.e. workers ).

Secondly, _Spatial availability_ is meaningful for defining edge population centers. For instance, the remote smaller population centers can be sufficiently accessible and in close proximity to the smaller employement centre; however the conventional accessibile measure obscures this 'sufficency'  by over-inflating th accessibly of population centers which are more central to more (and larger) employment centers. Conventional accessible does not shed light on how sufficiently accessible opportunties are available to the population. 

Conventional accessibly measures attempt to correct for this limitation by ... 
**is a solution to normalize conventional accessibility by population? assuming it is..**

However, ultimately if the global number of opportunities (jobs in our case) is not kept equal the accessibilty values assigned to each $i$ will be difficult to interpret and introduce basis. The proposed _spatial availability_ measure addresses this issue.

Additionally, it can be used to equivalently compare the accessible _spatial availability_ of opportunities for all origins globally; this is an important topic in equity analysis. For instance, considering the two remote small population centers in the top left corner it is evident that from the figure below that in one of the population centers there are _more_ jobs available than the people within the population center. 

```{r}
toy_avail_jobs_person_plot <- ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(color = avail_jobs_per_person,
              size = avail_jobs_per_person),
          shape = 17) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(size = avail_jobs_per_person),
          shape = 2) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          shape = 16,
          size = 5) +
  scale_color_gradient2(midpoint = 1)+
  guides(size = "none") + 
  theme(legend.position = "bottom",
        axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

toy_avail_jobs_person_plot
```

